<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Countdown Timer</title>
<style>
  body {
    background: #000;
    color: #0ff;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100vh;
    font-family: 'Arial', sans-serif;
  }

  .timer {
    display: flex;
    gap: 10px;
    font-size: 4rem;
    font-weight: bold;
    text-shadow: 0 0 5px #0ff, 0 0 10px #0ff, 0 0 20px #0ff;
  }

  .digit {
    display: inline-block;
    perspective: 1000px;
  }

  .flip {
    display: inline-block;
    transform-origin: bottom;
    animation: flip 0.6s ease-in-out forwards;
  }

  @keyframes flip {
    0% { transform: rotateX(0deg); }
    50% { transform: rotateX(-90deg); }
    100% { transform: rotateX(0deg); }
  }

  .message {
    margin-top: 20px;
    font-size: 1rem;
    max-width: 600px;
    text-align: center;
    color: #0ff;
    text-shadow: 0 0 5px #0ff, 0 0 10px #0ff;
  }
</style>
</head>
<body>

<div class="timer" id="timer">
  <span class="digit" id="days">0</span>日
  <span class="digit" id="hours">0</span>時間
  <span class="digit" id="minutes">0</span>分
  <span class="digit" id="seconds">0</span>秒
</div>
<div class="message" id="message">カウントダウンメッセージがここに表示されます。</div>

<script>
  const API_KEY = "AIzaSyCoOrWTtz2ZrjNOQwv_89XjtstKU3e2r-U"; 
  const CALENDAR_ID = "japanese__ja@holiday.calendar.google.com";

  let holidayDate = null; 
  let holidaysCache = []; // APIから取得した祝日をキャッシュ

  const dayMessages = [
    "地球での1日は、火星では約24時間39分、木星では約9時間56分です。",
    "地球での2日を過ごしても、金星ではまだ1日の半分にも満たない時間です。",
    "地球での3日を過ごすと、木星では約7.5日分、土星では約7.6日分に相当します。",
    // …4日〜100日のメッセージをここに追加…
  ];

  const daysEl = document.getElementById('days');
  const hoursEl = document.getElementById('hours');
  const minutesEl = document.getElementById('minutes');
  const secondsEl = document.getElementById('seconds');
  const messageEl = document.getElementById('message');

  let prev = { days: null, hours: null, minutes: null, seconds: null };

  async function fetchHolidays() {
    const now = new Date();
    const timeMin = now.toISOString();
    const timeMax = new Date(now.getFullYear() + 1, 11, 31).toISOString();

    const url = `https://www.googleapis.com/calendar/v3/calendars/${CALENDAR_ID}/events?key=${API_KEY}&timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`;
    const res = await fetch(url);
    const data = await res.json();

    if (!data.items) {
      console.error("祝日データが取得できませんでした:", data);
      return [];
    }

    return data.items.map(ev => new Date(ev.start.date));
  }

  function findNextLongHoliday(holidays) {
    const now = new Date();
    let date = new Date(now);

    for (let i = 0; i < 365; i++) {
      let streak = [];
      let d = new Date(date);

      while (true) {
        const isWeekend = d.getDay() === 0 || d.getDay() === 6;
        const isHoliday = holidays.some(h => h.toDateString() === d.toDateString());

        if (isWeekend || isHoliday) {
          streak.push(new Date(d));
          d.setDate(d.getDate() + 1);
        } else {
          break;
        }
      }

      if (streak.length >= 3 && streak[streak.length - 1] > now) {
        return streak[0];
      }

      date.setDate(date.getDate() + 1);
    }
    return null;
  }

  async function refreshHolidayDate() {
    if (holidaysCache.length === 0) {
      holidaysCache = await fetchHolidays();
    }
    holidayDate = findNextLongHoliday(holidaysCache);
    if (!holidayDate) {
      messageEl.textContent = "今後1年以内に3日以上の連休は見つかりませんでした。";
    }
  }

  function updateTimer() {
    if (!holidayDate) {
      messageEl.textContent = "次の連休を検索中…";
      return;
    }

    const now = new Date();
    let diff = Math.floor((holidayDate - now) / 1000);

    // もし連休開始を過ぎたら、次の連休を再検索
    if (diff <= 0) {
      refreshHolidayDate();
      return;
    }

    const days = Math.floor(diff / 86400);
    const hours = Math.floor((diff % 86400) / 3600);
    const minutes = Math.floor((diff % 3600) / 60);
    const seconds = diff % 60;

    if (days !== prev.days) flipDigit(daysEl, days);
    if (hours !== prev.hours) flipDigit(hoursEl, hours);
    if (minutes !== prev.minutes) flipDigit(minutesEl, minutes);
    if (seconds !== prev.seconds) flipDigit(secondsEl, seconds);

    prev = { days, hours, minutes, seconds };

    if (days >= 1 && days <= dayMessages.length) {
      messageEl.textContent = dayMessages[days - 1];
    } else if (days > dayMessages.length) {
      messageEl.textContent = "もうすぐ連休です。準備はできていますか？";
    } else {
      messageEl.textContent = "連休が始まりました！楽しんでください。";
    }
  }

  function flipDigit(el, value) {
    el.classList.remove('flip');
    void el.offsetWidth;
    el.textContent = value;
    el.classList.add('flip');
  }

  (async function init() {
    await refreshHolidayDate();
    setInterval(updateTimer, 1000);
    updateTimer();
  })();
</script>

</body>
</html>
