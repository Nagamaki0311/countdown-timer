<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>次の連休までカウントダウン</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');

  body {
    background: #000;
    color: #0ff;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100vh;
    font-family: 'Orbitron', 'Arial', sans-serif;
    padding: 0 20px;
    text-align: center;
  }

  .timer {
    display: flex;
    gap: 15px;
    font-size: 4rem;
    font-weight: 700;
    text-shadow: 0 0 8px #0ff, 0 0 16px #0ff, 0 0 32px #0ff;
  }

  .digit { display: inline-block; min-width: 3rem; }

  .morph {
    display: inline-block;
    animation: noise 0.2s steps(5) forwards;
  }

  @keyframes noise {
    0% { opacity: 1; transform: translate(0,0) scale(1); }
    20% { opacity: 0.3; transform: translate(-2px,1px) scale(1.05); }
    40% { opacity: 1; transform: translate(1px,-1px) scale(0.95); }
    60% { opacity: 0.5; transform: translate(-1px,2px) scale(1.02); }
    80% { opacity: 1; transform: translate(0,0) scale(1); }
    100% { opacity: 1; transform: translate(0,0) scale(1); }
  }

  .unit { display: flex; align-items: flex-end; }
  .unit small { font-size: 1.2rem; margin-left: 4px; margin-bottom: 4px; }

  .message {
    margin-top: 12px;
    font-size: 0.25rem;
    max-width: 600px;
    color: #0ff;
    text-shadow: 0 0 5px #0ff, 0 0 10px #0ff;
    line-height: 1.4;
  }
</style>
</head>
<body>
<div class="timer" id="timer">
  <div class="unit"><span class="digit" id="days">0</span><small>日</small></div>
  <div class="unit"><span class="digit" id="hours">0</span><small>時間</small></div>
  <div class="unit"><span class="digit" id="minutes">0</span><small>分</small></div>
  <div class="unit"><span class="digit" id="seconds">0</span><small>秒</small></div>
</div>
<div class="message" id="message">カウントダウンメッセージがここに表示されます。</div>

<script>
const API_KEY = "AIzaSyCoOrWTtz2ZrjNOQwv_89XjtstKU3e2r-U";
const CALENDAR_ID = "ja.japanese#holiday@group.v.calendar.google.com";

const dayMessages = {
  1: "明日から連休です！準備はできましたか？",
  2: "あと2日！ワクワクが止まらないですね。",
  3: "あと3日！そろそろ予定を確認してみましょう。",
  4: "あと4日！仕事も最後の追い込みです。",
  5: "あと5日！今週もあと少し！",
  6: "あと6日！週末の計画を練るのにちょうどいい。",
  7: "あと7日！1週間後に連休が始まります。"
};

let holidayDate = null;
let nowTime = null;
let prev = { days: null, hours: null, minutes: null, seconds: null };

// 日本時間をWorldTimeAPIから取得
async function fetchJapanTime() {
  try {
    const res = await fetch("https://worldtimeapi.org/api/timezone/Asia/Tokyo");
    const data = await res.json();
    nowTime = new Date(data.datetime);
  } catch(e) {
    console.error("日本時間取得エラー:", e);
    nowTime = new Date(new Date().toLocaleString("ja-JP", { timeZone: "Asia/Tokyo" }));
  }
}

// Googleカレンダーから祝日取得
async function fetchHolidays() {
  try {
    const timeMin = nowTime.toISOString();
    const endOfYear = new Date(nowTime.getFullYear() + 1, 11, 31).toISOString();
    const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(CALENDAR_ID)}/events?key=${API_KEY}&timeMin=${timeMin}&timeMax=${endOfYear}&singleEvents=true&orderBy=startTime`;
    const res = await fetch(url);
    const data = await res.json();
    if (!data.items) return [];
    return data.items
      .filter(ev => ev.start && ev.start.date)
      .map(ev => new Date(ev.start.date + "T00:00:00+09:00"));
  } catch (err) {
    console.error("祝日取得エラー:", err);
    return [];
  }
}

// 次の3日以上連休を探す
function findNextLongHoliday(holidays) {
  let date = new Date(nowTime);
  for (let i = 0; i < 365; i++) {
    let streak = [];
    let d = new Date(date);
    while (true) {
      const isWeekend = d.getDay() === 0 || d.getDay() === 6;
      const isHoliday = holidays.some(h => h.toDateString() === d.toDateString());
      if (isWeekend || isHoliday) {
        streak.push(new Date(d));
        d.setDate(d.getDate() + 1);
      } else {
        break;
      }
    }
    if (streak.length >= 3) return streak[0];
    date.setDate(date.getDate() + 1);
  }
  return null;
}

// 数字アニメーション
function morphDigit(el, value) {
  el.classList.remove("morph");
  void el.offsetWidth;
  el.textContent = value;
  el.classList.add("morph");
}

// タイマー更新
function updateTimer() {
  if (!holidayDate || !nowTime) {
    messageEl.textContent = "次の連休を検索中…";
    return;
  }

  nowTime = new Date(nowTime.getTime() + 1000); // 秒ごとに進める
  let diff = (holidayDate - nowTime) / 1000;

  if (diff <= 0) {
    messageEl.textContent = "連休が始まりました！楽しんでください。";
    return;
  }

  const days = Math.floor(diff / 86400);
  const hours = Math.floor((diff % 86400) / 3600);
  const minutes = Math.floor((diff % 3600) / 60);
  const seconds = Math.floor(diff % 60);

  if (days !== prev.days) morphDigit(daysEl, days);
  if (hours !== prev.hours) morphDigit(hoursEl, hours);
  if (minutes !== prev.minutes) morphDigit(minutesEl, minutes);
  if (seconds !== prev.seconds) morphDigit(secondsEl, seconds);

  prev = { days, hours, minutes, seconds };

  if (days >= 1 && dayMessages[days]) {
    messageEl.textContent = dayMessages[days];
  } else if (days > 0) {
    messageEl.textContent = "もうすぐ連休です。準備はできていますか？";
  } else {
    messageEl.textContent = "連休が始まりました！楽しんでください。";
  }
}

// DOM取得
const daysEl = document.getElementById("days");
const hoursEl = document.getElementById("hours");
const minutesEl = document.getElementById("minutes");
const secondsEl = document.getElementById("seconds");
const messageEl = document.getElementById("message");

// 初期化
(async function init() {
  await fetchJapanTime();
  const holidays = await fetchHolidays();
  holidayDate = findNextLongHoliday(holidays);
  if (!holidayDate) {
    messageEl.textContent = "今後1年以内に3日以上の連休は見つかりませんでした。";
  }
  updateTimer();
  setInterval(updateTimer, 1000);

  // 5分ごとにWorldTimeAPIから再取得して誤差補正
  setInterval(fetchJapanTime, 5 * 60 * 1000);
})();
</script>
</body>
</html>
